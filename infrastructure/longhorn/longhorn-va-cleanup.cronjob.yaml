apiVersion: v1
kind: ServiceAccount
metadata:
  name: longhorn-va-cleanup
  namespace: longhorn-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: longhorn-va-cleanup
rules:
  - apiGroups: ["storage.k8s.io"]
    resources: ["volumeattachments"]
    verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: longhorn-va-cleanup
subjects:
  - kind: ServiceAccount
    name: longhorn-va-cleanup
    namespace: longhorn-system
roleRef:
  kind: ClusterRole
  name: longhorn-va-cleanup
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: longhorn-va-cleanup
  namespace: longhorn-system
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: longhorn-va-cleanup
          containers:
            - name: cleanup
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  FOUND=0
                  for VA in $$(kubectl get volumeattachments \
                    -o jsonpath='{range .items[?(@.metadata.deletionTimestamp)]}{.metadata.name}{"\n"}{end}'); do
                    FOUND=$$((FOUND + 1))
                    echo "Clearing finalizer on stuck VolumeAttachment: $$VA"
                    kubectl patch volumeattachment "$$VA" \
                      --type=merge \
                      -p '{"metadata":{"finalizers":null}}'
                  done

                  if [ "$$FOUND" -eq 0 ]; then
                    echo "No stuck VolumeAttachments found"
                  else
                    echo "Cleaned up $$FOUND stuck VolumeAttachments"
                  fi
          restartPolicy: OnFailure
